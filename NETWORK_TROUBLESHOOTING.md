# Kaspa DNS Seeder 网络故障排除指南

## 问题描述

如果您遇到类似以下的连接错误：

```
Connection failed: Connection failed to 151.213.166.40:16110: transport error
Connection failed: Connection failed to 147.93.69.22:16110: status: Unimplemented
```

## 可能的原因

### 1. 网络层面问题
- **网络路由变化**: ISP可能更改了路由策略
- **防火墙规则更新**: 网络管理员可能更新了防火墙规则
- **ISP网络策略调整**: 运营商可能实施了新的网络限制

### 2. 服务端问题
- **节点下线**: 这些Kaspa节点可能已经停止服务
- **服务配置变化**: 节点可能更改了端口或协议
- **服务重启**: 节点可能正在重启过程中

### 3. 协议兼容性
- **gRPC版本不匹配**: 客户端和服务器可能使用不同的协议版本
- **服务接口变化**: 节点可能更新了API接口

## 解决方案

### 1. 使用诊断工具

我们添加了内置的诊断功能：

```bash
# 诊断特定节点的连接
./target/debug/kaseeder --diagnose "151.213.166.40:16110"

# 诊断另一个节点
./target/debug/kaseeder --diagnose "147.93.69.22:16110"
```

### 2. 运行网络检查脚本

```bash
# 运行全面的网络诊断
./scripts/network_check.sh
```

这个脚本会检查：
- 基本网络连接
- 端口可用性
- 网络路由
- 防火墙状态
- 系统资源

### 3. 改进的连接策略

我们已经改进了连接策略：

- **增加重试次数**: 从3次增加到5次
- **延长超时时间**: 连接超时从5秒增加到10秒
- **改进重试延迟**: 基础延迟从1秒增加到2秒
- **增加响应等待时间**: 从30秒增加到45秒

### 4. 手动网络测试

```bash
# 测试端口连接
nc -z -w5 151.213.166.40 16110

# 检查路由
traceroute 151.213.166.40

# 检查DNS解析
nslookup 151.213.166.40
```

## 预防措施

### 1. 定期健康检查
- 使用诊断工具定期检查关键节点
- 监控连接成功率
- 记录失败的连接模式

### 2. 网络配置优化
- 确保防火墙规则允许出站连接
- 检查ISP是否有端口限制
- 考虑使用VPN或代理（如果需要）

### 3. 备用节点
- 维护一个可靠的备用节点列表
- 实现自动故障转移机制
- 定期更新节点列表

## 日志分析

查看日志文件以获取更多信息：

```bash
# 查看错误日志
tail -f logs/kaseeder_error.log

# 查看应用日志
tail -f logs/kaseeder.log
```

## 联系支持

如果问题持续存在：

1. 收集诊断输出
2. 检查网络配置
3. 联系网络管理员
4. 在项目GitHub上报告问题

## 技术细节

### 错误类型分类

- **Transport Error**: 网络传输层错误，通常是连接被拒绝或超时
- **Unimplemented**: gRPC服务未实现，表示协议不兼容
- **Protocol Error**: 协议错误，可能是版本不匹配
- **Io Error**: I/O错误，通常是网络不可达

### 重试策略

```
重试次数: 5次
基础延迟: 2秒
延迟算法: 指数退避 (2^重试次数)
最大延迟: 32秒
总重试时间: 约62秒
```

### 超时配置

```
连接超时: 10秒
响应等待: 45秒
总操作超时: 约55秒
```

## 更新日志

- **v0.1.0**: 添加诊断功能和改进的连接策略
- 增加了网络诊断工具
- 改进了错误处理和日志记录
- 优化了重试和超时配置
