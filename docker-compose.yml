version: '3.8'

services:
  kaseeder:
    build: .
    container_name: kaseeder
    restart: unless-stopped
    ports:
      - "5354:5354"  # DNS service port (new default)
      - "3737:3737"  # gRPC/HTTP API port (new default)
      - "8080:8080"  # Profiling port (optional)
    volumes:
      - kaseeder_data:/app/data
      - kaseeder_logs:/app/logs
    environment:
      - RUST_LOG=kaseeder=info
    command: >
      --host seed.example.com
      --nameserver ns.example.com
      --seeder 127.0.0.1:16111
      --listen 0.0.0.0:5354
      --grpc-listen 0.0.0.0:3737
      --profile 8080
      --threads 8
      --log-level info
      --app-dir /app/data
    networks:
      - kaseeder_net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3737/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Testnet version (optional)
  kaseeder-testnet:
    build: .
    container_name: kaseeder-testnet
    restart: unless-stopped
    ports:
      - "5355:5354"  # Use different port to avoid conflicts
      - "3738:3737"
      - "8081:8080"
    volumes:
      - kaseeder_testnet_data:/app/data
      - kaseeder_testnet_logs:/app/logs
    environment:
      - RUST_LOG=kaseeder=info
    command: >
      --host seed-testnet.example.com
      --nameserver ns-testnet.example.com
      --seeder 127.0.0.1:16110
      --testnet
      --net-suffix 1
      --listen 0.0.0.0:5354
      --grpc-listen 0.0.0.0:3737
      --profile 8080
      --threads 4
      --log-level info
      --app-dir /app/data
    networks:
      - kaseeder_net
    profiles:
      - testnet

volumes:
  kaseeder_data:
    driver: local
  kaseeder_logs:
    driver: local
  kaseeder_testnet_data:
    driver: local
  kaseeder_testnet_logs:
    driver: local

networks:
  kaseeder_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
